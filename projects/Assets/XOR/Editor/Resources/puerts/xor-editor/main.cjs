(()=>{"use strict";var e={3110:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerEvent=void 0,(r=t.WorkerEvent||(t.WorkerEvent={})).Ready="ready",r.StartProgream="startProgream",r.FileChanged="fileChanged"},5957:e=>{e.exports=require("csharp")},2048:e=>{e.exports=require("fs")}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}(()=>{const e=r(5957),t=r(3110),{Path:s}=e.System.IO;class i{constructor(e){this.ci=e}start(r,i){if(this._worker&&this._worker.isAlive)throw new Error("invalid operation");const o=this._createWorker(),n=new e.XOR.Services.Program;if(n.root=s.GetDirectoryName(r),n.Reset(),o.post(t.WorkerEvent.StartProgream,{project:r,program:n},!0),this._worker=o,this.ci.SetWorker.Invoke(o.source),this.ci.SetProgram.Invoke(n),i)try{let t=s.GetDirectoryName(r);this._watcher=this._createWatcher(t),e.XOR.Logger.Log(`<b>nodejs.FSWacther:</b> ${t}`)}catch(e){console.error(e)}}stop(){this._watcher&&this._watcher.close(),this._watcher=null,this._worker&&this._worker.stop(),this._worker=null,this.ci.SetWorker.Invoke(null),this.ci.SetProgram.Invoke(null)}bind(){let t=new e.XOR.Services.TSInterfaces;return t.Stop=()=>this.stop(),t.Start=(e,t)=>this.start(e,t),t.FileChanged=e=>this.change(e),t}change(e){this._changeEvents?this._changeEvents.add(e):(this._changeEvents=new Set,this._changeEvents.add(e),setTimeout((()=>{this.sendChangeEvent([...this._changeEvents]),this._changeEvents=null}),100))}sendChangeEvent(e){this._worker&&this._worker.isAlive&&this._worker.isInitialized?this._worker.post(t.WorkerEvent.FileChanged,e,!0):console.warn("worker is not alive or initializing:")}_createWorker(){const t=new e.XOR.ThreadDebuggerOptions,r=new e.XOR.ThreadOptions;r.remote=!1,r.isEditor=!0,r.debugger=t;const s=new e.XOR.MixerLoader,i=new xor.ThreadWorker(s,r);return i.start("puerts/xor-editor/child"),xor.globalListener.quit.add((()=>i.stop())),i}_createWatcher(e){const t=r(2048),i=[".ts",".tsx"],o=t.watch(e,{encoding:"utf8",persistent:!0,recursive:!0},((t,r)=>{"string"==typeof r&&i.includes(s.GetExtension(r))&&this.change(s.GetFullPath(s.Combine(e,r)))}));return xor.globalListener.quit.add((()=>o.close())),o}}function o(e){return new i(e).bind()}!function(){(global||globalThis||this).init=o}()})()})();